<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Bayesian Regression Models 2 – Advanced Quantitative Methods for Linguistic Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./week9.html" rel="next">
<link href="./week4.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./week5.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Bayesian Regression Models 2</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Advanced Quantitative Methods for Linguistic Data</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Bayesian basics 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Bayesian basics 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesian Regression Models 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week5.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Bayesian Regression Models 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week9.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bayesian Hierarchical Models 1</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Bayesian Hierarchical Models 2</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Bayesian Hierarchical Models 3</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Models for discrete data: counts, scales, and frequencies</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Multivariate models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Generalized Additive Models (GAMs)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./week7.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Generalized additive mixed-effects models (GAMMs)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bayesian_gamms.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Bayesian GAMs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./FDA_edited.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Functional principal components analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#preliminaries" id="toc-preliminaries" class="nav-link active" data-scroll-target="#preliminaries"><span class="header-section-number">4.1</span> Preliminaries</a>
  <ul class="collapse">
  <li><a href="#datasets" id="toc-datasets" class="nav-link" data-scroll-target="#datasets"><span class="header-section-number">4.1.1</span> Datasets</a></li>
  </ul></li>
  <li><a href="#sec-model-quality" id="toc-sec-model-quality" class="nav-link" data-scroll-target="#sec-model-quality"><span class="header-section-number">4.2</span> Model quality metrics</a>
  <ul class="collapse">
  <li><a href="#sec-example-nonlinear" id="toc-sec-example-nonlinear" class="nav-link" data-scroll-target="#sec-example-nonlinear"><span class="header-section-number">4.2.1</span> Example: nonlinear effect of <code>WrittenFrequency</code></a></li>
  </ul></li>
  <li><a href="#checking-a-fitted-model" id="toc-checking-a-fitted-model" class="nav-link" data-scroll-target="#checking-a-fitted-model"><span class="header-section-number">4.3</span> Checking a fitted model</a>
  <ul class="collapse">
  <li><a href="#posterior-plots" id="toc-posterior-plots" class="nav-link" data-scroll-target="#posterior-plots"><span class="header-section-number">4.3.1</span> Posterior plots</a></li>
  <li><a href="#mcmc-diagnostics" id="toc-mcmc-diagnostics" class="nav-link" data-scroll-target="#mcmc-diagnostics"><span class="header-section-number">4.3.2</span> MCMC Diagnostics</a></li>
  </ul></li>
  <li><a href="#sec-brm2-contrasts" id="toc-sec-brm2-contrasts" class="nav-link" data-scroll-target="#sec-brm2-contrasts"><span class="header-section-number">4.4</span> Working with multi-level factors and contrasts</a></li>
  <li><a href="#sec-brm2-extra" id="toc-sec-brm2-extra" class="nav-link" data-scroll-target="#sec-brm2-extra"><span class="header-section-number">4.5</span> Extra</a>
  <ul class="collapse">
  <li><a href="#frequentist-models-for-nonlinear-effect-of-writtenfrequency" id="toc-frequentist-models-for-nonlinear-effect-of-writtenfrequency" class="nav-link" data-scroll-target="#frequentist-models-for-nonlinear-effect-of-writtenfrequency"><span class="header-section-number">4.5.1</span> Frequentist models for nonlinear effect of <code>WrittenFrequency</code></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Bayesian Regression Models 2</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>These lecture notes cover topics from:</p>
<ul>
<li><span class="citation" data-cites="mcelreath2020statistical">McElreath (<a href="references.html#ref-mcelreath2020statistical" role="doc-biblioref">2020</a>)</span> Sec. 7.3-7.5.1, 9.3, 9.4-9.5</li>
<li><span class="citation" data-cites="kurz2021statistical">Kurz (<a href="references.html#ref-kurz2021statistical" role="doc-biblioref">2023</a>)</span>, same sections (7.3-7.5.1, …)</li>
<li>To review as necessary: Sec. 7.2 and 7.3 of <em>RMLD</em> <span class="citation" data-cites="rmld-book">(<a href="references.html#ref-rmld-book" role="doc-biblioref">Sonderegger 2023</a>)</span>
<ul>
<li>On contrast coding and post-hoc tests for frequentist models</li>
<li>Assumed as background for <a href="#sec-brm2-contrasts" class="quarto-xref"><span>Section 4.4</span></a> below.</li>
</ul></li>
</ul>
<p>The McElreath/Kurz reading above is overkill if you just want to understand the basics of model quality metrics and model diagnostics, illustrated in this file. It will give you a good background in exactly what these metrics/diagnostics are doing, but some students don’t find this useful. TODO for the future: list two possible readings from McElreath, for less and more detail.</p>
<p>Topics:</p>
<ul>
<li>Model quality metrics</li>
<li>Checking a fitted model
<ul>
<li>Posterior plots</li>
<li>MCMC diagnostics</li>
</ul></li>
<li>Multi-level factors and contrasts</li>
</ul>
<section id="preliminaries" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="preliminaries"><span class="header-section-number">4.1</span> Preliminaries</h2>
<p>Load libraries we will need:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(brms)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom) <span class="co"># for tidy model summaries</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidybayes)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayestestR)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(languageR) <span class="co"># for `english' dataset</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(arm)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loo)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(emmeans) <span class="co"># for working with multi-level factors</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Practical note
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If you have loaded <code>rethinking</code>, you need to detach it before using brms. See <span class="citation" data-cites="kurz2021statistical">Kurz (<a href="references.html#ref-kurz2021statistical" role="doc-biblioref">2023</a>)</span> Sec. 4.3.1.</p>
<p>I use the <code>file</code> argument when fitting <code>brms</code> models to make compiling this document easier (so the models don’t refit every time I compile). You may or may not want to do this for your own models. See <code>file</code> and <code>file_refit</code> arguments in <code>?brm</code>.</p>
</div>
</div>
</div>
<p>We’ll make greater use today of the <a href="https://mc-stan.org/bayesplot/">bayesplot</a> package, which we previously used for posterior predictive checks (<a href="week3.html" class="quarto-xref"><span>Chapter 2</span></a>). This package also has extensive functionality for plotting MCMC draws and plotting MCMC diagnostics (such as trace plots), as covered in useful <a href="https://mc-stan.org/bayesplot/articles/index.html">vignettes</a> and the bayesplot paper <span class="citation" data-cites="gabry2019visualization">(<a href="references.html#ref-gabry2019visualization" role="doc-biblioref">Gabry et al. 2019</a>)</span>.</p>
<p>We’ll start using the <a href="http://mc-stan.org/loo/reference/loo-package.html">loo</a> package <span class="citation" data-cites="loo-package">Vehtari et al. (<a href="references.html#ref-loo-package" role="doc-biblioref">2024</a>)</span>, which implements methods for calculating model quality criteria from <span class="citation" data-cites="vehtari2017practical">Vehtari, Gelman, and Gabry (<a href="references.html#ref-vehtari2017practical" role="doc-biblioref">2017</a>)</span> that use “pointwise out-of-sample prediction accuracy”: LOO-CV and WAIC. See <a href="https://mc-stan.org/loo/articles/loo2-example.html">vignette</a>.</p>
<section id="datasets" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1" class="anchored" data-anchor-id="datasets"><span class="header-section-number">4.1.1</span> Datasets</h3>
<p>Load the <code>diatones</code> dataset and perform some data cleaning and recoding (see <a href="week2.html#sec-bb1-prelim" class="quarto-xref"><span>Section 1.1</span></a>, <a href="week4.html#sec-brm1-datasets" class="quarto-xref"><span>Section 3.1.1</span></a>):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>diatones <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"https://osf.io/tqjm8/download"</span>, <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># make numeric versions of all categorical predictors, while saving original versions</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>diatones <span class="ot">&lt;-</span> diatones <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll1_coda_orig =</span> syll1_coda,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll2_coda_orig =</span> syll2_coda,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll2_td_orig =</span> syll2_td,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="do">## turns no/yes -&gt; 0/1</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll1_coda =</span> <span class="fu">ifelse</span>(syll1_coda <span class="sc">==</span> <span class="st">"no"</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## turns '0'/'C'/'CC'/'CCC' -&gt; 0/1/2/3</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll2_coda =</span> <span class="fu">str_count</span>(syll2_coda_orig, <span class="st">"C"</span>),</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll2_td =</span> <span class="fu">ifelse</span>(syll2_td <span class="sc">==</span> <span class="st">"no"</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="do">## standardize all predictors using arm::rescale</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>diatones <span class="ot">&lt;-</span> diatones <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll1_coda =</span> <span class="fu">rescale</span>(syll1_coda_orig),</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll2_td =</span> <span class="fu">rescale</span>(syll2_td_orig),</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">syll2_coda =</span> <span class="fu">rescale</span>(syll2_coda),</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">frequency =</span> <span class="fu">rescale</span>(frequency)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also will use the <code>english</code> dataset from languageR, defining <span class="math inline">\(n=250\)</span> and <span class="math inline">\(n = 25\)</span> subsets after centering variables we’ll use in models below—all as in previous chapters.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># center predictors</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>english <span class="ot">&lt;-</span> <span class="fu">mutate</span>(english,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">WrittenFrequency_c =</span> <span class="fu">scale</span>(WrittenFrequency, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">Familiarity_c =</span> <span class="fu">scale</span>(Familiarity, <span class="at">scale =</span> <span class="cn">FALSE</span>),</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">SubjectYoung =</span> <span class="fu">as.numeric</span>(AgeSubject) <span class="sc">-</span> <span class="fl">1.5</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="do">## set seed, so you'll get the same "random" sample</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>english_250 <span class="ot">&lt;-</span> english[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(english), <span class="dv">250</span>), ]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="do">## set seed, so you'll get the same "random" sample</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>english_25 <span class="ot">&lt;-</span> english[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(english), <span class="dv">25</span>), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we load the <code>french_cdi_24</code> dataset. It is described in Sec. 7.1.1. of <em>RMLD</em> (and in <span class="quarto-unresolved-ref">?sec-hw1</span> of this e-book), where you can learn more if needed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>french_cdi_24 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="at">file =</span> <span class="st">"https://osf.io/uhd2n/download"</span>, <span class="at">stringsAsFactors =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Perform pre-processing described in Sec. 7.1.1. of <em>RMLD</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>french_cdi_24 <span class="ot">&lt;-</span> <span class="fu">filter</span>(french_cdi_24, data_id <span class="sc">==</span> <span class="dv">140275</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(lexical_class <span class="sc">!=</span> <span class="st">"other"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">lexical_class =</span> <span class="fu">fct_relevel</span>(lexical_class, <span class="st">"function_words"</span>, <span class="st">"verbs"</span>, <span class="st">"adjectives"</span>, <span class="st">"nouns"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">droplevels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This restricts the data to a single child (140275), aged 24 months, and relevels <code>lexical_class</code> in the theoretically-expected order.</p>
</section>
</section>
<section id="sec-model-quality" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-model-quality"><span class="header-section-number">4.2</span> Model quality metrics</h2>
<p>Summarizing <span class="citation" data-cites="mcelreath2020statistical">McElreath (<a href="references.html#ref-mcelreath2020statistical" role="doc-biblioref">2020</a>)</span> Sec. 7.4:</p>
<p>The ideal for model quality metrics is out-of-sample deviance. This can never be computed, so we approximate using <em>leave-one-out-cross-validation</em>. This is usually impractical to compute—it would require refitting the model <span class="math inline">\(n\)</span> times, where <span class="math inline">\(n\)</span> = number of observations. So we approximate, in one of two ways</p>
<ul>
<li><em>PSIS-LOO-CV</em> (“Pareto-smoothed importance-sampling leave-one-out cross-validation”), a.k.a. <em>PSIS</em></li>
<li>Implemented as <code>loo()</code> in the loo package</li>
<li><em>WAIC</em> (“Widely-applicable information criterion”)</li>
<li>Implemented as <code>waic()</code></li>
</ul>
<p>In principle, these are different approaches, based on cross-validation versus calculating an <em>information criterion</em>, analagous to AIC/BIC for frequentist models. In practice, both PSIS and WAIC measure the same thing (out-of-sample deviance), and the larger the dataset, the more similar they will be.</p>
<p>If they give different qualitative results (with no errors in WAIC/PSIS calculation) you should be circumspect.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Practical note: PSIS or WAIC?
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>Which of PSIS or WAIC should actually be used for model comparison in a concrete case? McElreath notes that PSIS and WAIC may each be better for different model types (Sec. 7.4.3), but seems to recommend defaulting to PSIS, because it “has a distinct advantage in warning the user about when it is unreliable” via the <span class="math inline">\(k\)</span>-values it computes for each observation. However, WAIC is faster to compute—much faster, for large datasets or complex models—and the current WAIC implementation in loo also reports when it’s probably unreliable (and recommends using PSIS instead).</p>
<p>My usual workflow for model comparison is:</p>
<ol type="1">
<li>First use WAIC</li>
<li>If there are warnings, switch to PSIS (a.k.a. “loo”, in the loo package)</li>
<li>If there are warnings about Pareto <span class="math inline">\(k\)</span> values being too large, follow the package’s recommendation to compute PSIS with moment matching instead (see <code>?loo_moment_match</code>).</li>
</ol>
<p>My understanding is that Options 1–3 are (usually) progressively more accurate and slower.</p>
</div>
</div>
</div>
<section id="sec-example-nonlinear" class="level3" data-number="4.2.1">
<h3 data-number="4.2.1" class="anchored" data-anchor-id="sec-example-nonlinear"><span class="header-section-number">4.2.1</span> Example: nonlinear effect of <code>WrittenFrequency</code></h3>
<p>This section assumes as background the introduction to non-linear effects of predictors in Sec. 7.5 of <em>RMLD</em>, especially Sec. 7.5.3, where a similar example for frequentist linear regression is given.</p>
<p>The empirical effect of frequency (<code>WrittenFrequency</code>) on reaction time (<code>RTlexdec</code>) for the <code>english_250</code> data is:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>english_250 <span class="sc">%&gt;%</span> <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> WrittenFrequency, <span class="at">y =</span> RTlexdec)) <span class="sc">+</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="fu">aes</span>(<span class="at">color =</span> AgeSubject))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="do">## `geom_smooth()` using method = 'loess' and formula = 'y ~ x'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>It’s not immediately clear here whether the effect is linear or non-linear, and what degree the non-linear effect would be.</p>
<p>We assess this by comparing models fit with <code>AgeSubject</code> and different effects of <code>WrittenFrequency</code>:</p>
<ul>
<li>Linear effect of <code>WrittenFrequency</code> (equivalent to <code>english_m43</code> from <a href="week4.html#sec-mult-lin-reg" class="quarto-xref"><span>Section 3.3</span></a>)</li>
<li>Polynomial effect of <code>WrittenFrequency</code>, degree=2 (quadratic)</li>
<li>Polynomial effect of <code>WrittenFrequency</code>, degree=3 (cubic)</li>
<li>Polynomial effect of <code>WrittenFrequency</code>, degree=4 (quartic)</li>
</ul>
<p>Fit these models, using the same priors as in <a href="week4.html#sec-mult-lin-reg" class="quarto-xref"><span>Section 3.3</span></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>prior_1 <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> b),</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>english_m51 <span class="ot">&lt;-</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> english_250,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> WrittenFrequency_c <span class="sc">+</span> SubjectYoung,</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> gaussian,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> prior_1,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"models/english_m51.brm"</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>english_m52 <span class="ot">&lt;-</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> english_250,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">poly</span>(WrittenFrequency_c, <span class="dv">2</span>) <span class="sc">+</span> SubjectYoung,</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> gaussian,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> prior_1,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"models/english_m52.brm"</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>english_m53 <span class="ot">&lt;-</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> english_250,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">poly</span>(WrittenFrequency_c, <span class="dv">3</span>) <span class="sc">+</span> SubjectYoung,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> gaussian,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> prior_1,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"models/english_m53.brm"</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>english_m54 <span class="ot">&lt;-</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> english_250,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">poly</span>(WrittenFrequency_c, <span class="dv">4</span>) <span class="sc">+</span> SubjectYoung,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> gaussian,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> prior_1,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"models/english_m54.brm"</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>While the <code>loo()</code> and <code>waic()</code> functions can be applied to a fitted model to calculate PSIS or WAIC, the recommended workflow is instead to add them to the fitted model using <code>add_criterion()</code>. This saves the specified criterion to the model file (indicated by the <code>file</code> argument when you fit the model) so it is only calculated once per fitted model. This is useful because PSIS/WAIC take a lot of time to compute, especially for more complex models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="do">## add both WAIC and LOO</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>english_m51 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(english_m51, <span class="fu">c</span>(<span class="st">"waic"</span>, <span class="st">"loo"</span>))</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>english_m52 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(english_m52, <span class="fu">c</span>(<span class="st">"waic"</span>, <span class="st">"loo"</span>))</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>english_m53 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(english_m53, <span class="fu">c</span>(<span class="st">"waic"</span>, <span class="st">"loo"</span>))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>english_m54 <span class="ot">&lt;-</span> <span class="fu">add_criterion</span>(english_m54, <span class="fu">c</span>(<span class="st">"waic"</span>, <span class="st">"loo"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Example WAIC and LOO output for one model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">waic</span>(english_m53)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Computed from 4000 by 250 log-likelihood matrix.</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="do">##           Estimate   SE</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="do">## elpd_waic    263.9 12.3</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="do">## p_waic         5.4  0.7</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="do">## waic        -527.8 24.5</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">loo</span>(english_m53)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Computed from 4000 by 250 log-likelihood matrix.</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="do">##          Estimate   SE</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="do">## elpd_loo    263.9 12.3</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="do">## p_loo         5.4  0.7</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="do">## looic      -527.8 24.5</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="do">## ------</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="do">## MCSE of elpd_loo is 0.0.</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="do">## MCSE and ESS estimates assume MCMC draws (r_eff in [0.5, 1.7]).</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="do">## All Pareto k estimates are good (k &lt; 0.7).</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="do">## See help('pareto-k-diagnostic') for details.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The most important output here is:</p>
<ul>
<li>The Estimate and SE of PSIS (a.k.a. “LOO”) and WAIC, in the <code>waic</code> and <code>looic</code> rows.
<ul>
<li>Note that a rough 95% CredI of WAIC or PSIS would be Estimate +- 1.96*SE.</li>
</ul></li>
<li>Pareto <span class="math inline">\(k\)</span> estimates
<ul>
<li>These values, one per observation, go into the calculation of PSIS-LOO.</li>
<li>When <span class="math inline">\(k&gt;\)</span> some threshold, by default 0.7, LOO is unreliable.</li>
<li>Observations with <span class="math inline">\(k&gt;\)</span> threshold are influential/potential “outliers”.</li>
</ul></li>
</ul>
<p>Other output is less important.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<p>Note how similar LOO and WAIC are for this dataset, as expected for large enough <span class="math inline">\(n\)</span> (here, <span class="math inline">\(n=250\)</span>).</p>
<p>These metrics can be used for model comparison via the <code>loo_compare()</code> function from loo:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m51, english_m52, english_m53, english_m54, <span class="at">criterion =</span> <span class="st">"waic"</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53  0.0       0.0   </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52 -0.6       1.4   </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54 -0.7       0.2   </span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 -1.2       1.8</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m51, english_m52, english_m53, english_m54, <span class="at">criterion =</span> <span class="st">"loo"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53  0.0       0.0   </span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52 -0.6       1.4   </span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54 -0.8       0.3   </span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 -1.2       1.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For example: the difference in deviance (ELPD) based on WAIC between the cubic (<code>english_m53</code>) and quadratic (<code>english_m52</code>) models is 0.6, with standard error of 1.4. Thus, a rough 95% CredI for this difference in deviance is <span class="math inline">\([0.6 - 1.96*1.4, 0.6 + 1.96*1.4]\)</span> = <span class="math inline">\([-2.1, 3.3]\)</span>.</p>
<p>In terms of LOO or WAIC, the cubic model (<code>english_m53</code>) wins: it has lower LOO than model <code>english_52</code> by 0.6, which is lower than <code>english_m54</code> by 0.2 (difference between 0.8 and 0.6), and so on. So we’d <strong>choose the cubic model</strong>.</p>
<p>The SE values suggest a slightly more complex picture: the 95% CIs for the difference in deviance with the next-best model (quadratic) or the least-good model (linear) overlap, but the 95% CI with the next-next-best model (quartic) does not:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI of diff: overlaps 0</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m53, english_m52)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53  0.0       0.0   </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52 -0.6       1.4</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI of diff: doesn't overlap 0</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m53, english_m54)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53  0.0       0.0   </span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54 -0.8       0.3</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% CI of diff: overlaps 0</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m53, english_m51)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53  0.0       0.0   </span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 -1.2       1.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The most conservative option would be to just <strong>choose the linear model</strong> (<code>english_m51</code>), which doesn’t differ from any nonlinear model by the 95% CredI method:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## 95% CredI all overlap 0</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m53, english_m51)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53  0.0       0.0   </span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 -1.2       1.8</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m52, english_m51)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52  0.0       0.0   </span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 -0.6       1.6</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_compare</span>(english_m54, english_m51)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="do">##             elpd_diff se_diff</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54  0.0       0.0   </span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 -0.4       1.8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When it is of interest to choose a single “best” model”, <strong>both methods are used in current practice</strong>:</p>
<ul>
<li>Choose model with lowest WAIC/PSIS</li>
<li>Choose the simplest model using 95% CredI on WAIC/PSIS differences.</li>
</ul>
<p>The second method is more conservative.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Broader context: Using PSIS/WAIC for model selection
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>The two methods above—choosing the model with lowest PSIS (or WAIC) versus choosing the model which beats others by at least 2 SE—can be thought of as two options on a continuum, where you choose the best model depending on which one beats others by at least X SE (where X = 0 or 2). There is no right answer here, and no reason you need to be restricted to X = 0 or 2. These are just conventional choices for how conservative you want to be, like the commonly used AIC and BIC for frequentist models just correspond to different penalty terms in “data likelihood minus penalty”.</p>
<p>In fact, there is no reason you need to choose a “best model”—McElreath advises against it. <span class="citation" data-cites="flego2021leveraging">Flego and Forrest (<a href="references.html#ref-flego2021leveraging" role="doc-biblioref">2021</a>)</span> is a nice example from phonetics where different X are used to differentiate between models which are more and less likely for the shape of vowel formant trajectories (linear, quadratic, an interpolation between two points, etc.).</p>
<p>An interesting option is <em>model averaging</em>, where instead of choosing a best model, you ask, “what combination of a set of models best predicts the data”, to get a weight for each model (where the weights add up to one). This is implemented in the loo package (see <code>?loo_model_weights</code>).</p>
<p>For example, for the four models considered above:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">loo_model_weights</span>(english_m51, english_m52, english_m53, english_m54)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Method: stacking</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">## ------</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="do">##             weight</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51 0.062 </span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52 0.171 </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53 0.767 </span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54 0.000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The data is best described as 77% the cubic model, 17% the quadratic model, and 6% the linear model.</p>
</div>
</div>
</div>
<p>For comparison, shown in <a href="#sec-brm2-extra" class="quarto-xref"><span>Section 4.5</span></a>: when we compare frequentist linear regression models for the same case, we get that the linear model or cubic model are best, depending on the method used for model comparison (e.g.&nbsp;AIC vs.&nbsp;BIC).</p>
<!-- ```{r, results=FALSE, message=FALSE, warning=FALSE} -->
<!-- english_m54 <- -->
<!--   brm(data = english_25, -->
<!--       RTlexdec ~ 1 + WrittenFrequency_c + SubjectYoung, -->
<!--       family = gaussian, -->
<!--       prior = c(prior(normal(0, 100), class=Intercept), -->
<!--                 prior(normal(0,5), class=b), -->
<!--                 prior(exponential(1), class = sigma) -->
<!--       ), -->
<!--       file='models/english_m54.brm' -->
<!--   ) -->
<!-- english_m55 <- -->
<!--   brm(data = english_25, -->
<!--       RTlexdec ~ 1 + poly(WrittenFrequency_c,2) + SubjectYoung, -->
<!--       family = gaussian, -->
<!--       prior = c(prior(normal(0, 100), class=Intercept), -->
<!--                 prior(normal(0,5), class=b), -->
<!--                 prior(exponential(1), class = sigma) -->
<!--       ), -->
<!--       file='models/english_m55.brm' -->
<!--   ) -->
<!-- english_m56 <- -->
<!--   brm(data = english_25, -->
<!--       RTlexdec ~ 1 + poly(WrittenFrequency_c,3) + SubjectYoung, -->
<!--       family = gaussian, -->
<!--       prior = c(prior(normal(0, 100), class=Intercept), -->
<!--                 prior(normal(0,5), class=b), -->
<!--                 prior(exponential(1), class = sigma) -->
<!--       ), -->
<!--       file='models/english_m56.brm' -->
<!--   ) -->
<!-- english_m54 <- add_criterion(english_m54, c('waic', 'loo')) -->
<!-- english_m55 <- add_criterion(english_m55,c('waic', 'loo')) -->
<!-- english_m56 <- add_criterion(english_m56, c('waic', 'loo')) -->
<!-- loo(english_m54, english_m55, english_m56) -->
<!-- loo(english_m54) -->
<!-- ``` -->
<div id="exr-brm2-1" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4.1</strong></span> &nbsp;</p>
<ol type="a">
<li><p>Fit the same four models as above, but now to <code>english_25</code>, and recalculate LOO/WAIC.</p></li>
<li><p>Which model is best, in terms of LOO?</p></li>
<li><p>What conclusion do the 95% CIs of LOO differences suggest?</p></li>
<li><p>Does this conclusion fit your intuition from plotting the data <code>geom_smooth()</code> of <code>WrittenFrequency</code> vs <code>RTlexdec</code>)? If you get different answers for (b) and (c), which better fits this plot?</p></li>
<li><p>Your “best model” from (b) should be different from the <code>english_250</code> case. Why is this?</p></li>
<li><p><em>Extra</em>: Try (a)–(d) for a model fit to the entire <code>english</code> dataset. (You should now find clear evidence for a nonlinear effect.)</p></li>
</ol>
<!-- f.  *Extra* Make an analogous plot (to @exr-brm2-1(d)) for the `english_250` data, and compare to the results of (1) the Bayesian model comparison and (2) the frequentist model comparison we performed above. Does one better match your intuition from plotting the data? -->
</div>
<!-- ```{r} -->
<!-- ## these are equivalent to mlogreg_mod_1, mlogreg_mod_2, mlogreg_mod_3 in RMLD Ch. 6 -->
<!-- diatones_m51 <-brm(data = diatones, -->
<!--                    stress_shifted | trials(1) ~ syll2_coda + syll2_td + frequency + syll1_coda, -->
<!--                    family = binomial, -->
<!--                    prior = c(prior(normal(0,5), class=Intercept), -->
<!--                              prior(normal(0,3), class=b)), -->
<!--                    file='models/diatones_m41.brm') -->
<!-- diatones_m52 <-brm(data = diatones, -->
<!--                    stress_shifted | trials(1) ~ frequency*(syll2_coda + syll2_td + syll1_coda), -->
<!--                    family = binomial, -->
<!--                    prior = c(prior(normal(0,5), class=Intercept), -->
<!--                              prior(normal(0,3), class=b)), -->
<!--                    file='models/diatones_m52.brm') -->
<!-- diatones_m53 <-brm(data = diatones, -->
<!--                    stress_shifted | trials(1) ~ frequency*(syll2_td + syll1_coda) + syll2_coda, -->
<!--                    family = binomial, -->
<!--                    prior = c(prior(normal(0,5), class=Intercept), -->
<!--                              prior(normal(0,3), class=b)), -->
<!--                    file='models/diatones_m53.brm') -->
<!-- ``` -->
<!-- ```{r} -->
<!-- loo(diatones_m51, diatones_m52, diatones_m53) -->
<!-- ``` -->
</section>
</section>
<section id="checking-a-fitted-model" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="checking-a-fitted-model"><span class="header-section-number">4.3</span> Checking a fitted model</h2>
<p>Once fitted, a model needs to be checked to be confident in its results. Methods for this are discussed in McElreath Sec. 9.4-9.5.</p>
<section id="posterior-plots" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1" class="anchored" data-anchor-id="posterior-plots"><span class="header-section-number">4.3.1</span> Posterior plots</h3>
<p>The most basic visual check of a fitted model is examining the posterior distribution of model parameters:</p>
<ol type="1">
<li>Each parameter’s (marginal) distribution</li>
<li>Pairwise distributions</li>
</ol>
<ol type="1">
<li>is crucial, while (2) is nice but not always feasible as the number of parameters increases.</li>
</ol>
<p>Let’s see examples of what these plots look like for a “good” model, and then one where something has gone wrong.</p>
<section id="example-good-model" class="level4" data-number="4.3.1.1">
<h4 data-number="4.3.1.1" class="anchored" data-anchor-id="example-good-model"><span class="header-section-number">4.3.1.1</span> Example: good model</h4>
<p>Consider model <code>english_m53</code>, the “cubic” model chosen in <a href="#sec-example-nonlinear" class="quarto-xref"><span>Section 4.2.1</span></a> as having the lowest WAIC/PSIS. We first plot the (marginal) posterior distribution of each parameter, using <code>mcmc_plot()</code> from brms—this is a convenience function for calling MCMC plotting functions from the bayesplot package on brms models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(english_m53, <span class="at">type =</span> <span class="st">"hist"</span>, <span class="at">bins =</span> <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Now consider pairwise posterior distributions, restricting just to parameter starting with <code>b</code> (which are the regression coefficients):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_pairs</span>(english_m53,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">regex_pars =</span> <span class="st">"^b"</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">off_diag_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span>, <span class="at">alpha =</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">5</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Here we use <code>mcmc_pairs()</code>, one of <a href="https://cran.r-project.org/web/packages/bayesplot/vignettes/plotting-mcmc-draws.html#Bivariate_plots">several functions</a> for bivariate posterior distribution summaries provided by bayesplot.</p>
<p>It is visually clear that there are enough samples to tell the shape of each marginal and pairwise distribution (ellipses/bell curves = multivariate Gaussians).</p>
</section>
<section id="example-bad-model" class="level4" data-number="4.3.1.2">
<h4 data-number="4.3.1.2" class="anchored" data-anchor-id="example-bad-model"><span class="header-section-number">4.3.1.2</span> Example: bad model</h4>
<p>What would posteriors plots (here) and MCMC diagnostics (next section) look like for a model where we hadn’t sampled for long enough, or there was a problem with the model specification?</p>
<p>Let’s use the high-collinearity example model from <a href="week4.html#sec-brm1-collinearity" class="quarto-xref"><span>Section 3.3.3</span></a> (<code>english_collin_m1</code>), but now refit using:</p>
<ul>
<li>4 chains</li>
<li><strong>100</strong> samples, of which 25/75 are warmup/real samples.</li>
</ul>
<p>This is obviously too few samples, but this will let us see what plots for a bad model look like.</p>
<p>Fit this model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># make sure you get the same "random" result:</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>english_iter100_m51 <span class="ot">&lt;-</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">brm</span>(</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> english_25,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> WrittenFrequency_c <span class="sc">+</span> Familiarity_c <span class="sc">+</span> SubjectYoung,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">family =</span> gaussian,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">100</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> b),</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>      <span class="fu">prior</span>(<span class="fu">exponential</span>(<span class="dv">1</span>), <span class="at">class =</span> sigma)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    ), <span class="at">iter =</span> <span class="dv">100</span>, <span class="at">warmup =</span> <span class="dv">25</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">file =</span> <span class="st">"models/english_iter100_m51"</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Model output:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>english_iter100_m51</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: Parts of the model have not converged (some Rhats are &gt; 1.05). Be</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## careful when analysing the results! We recommend running more iterations and/or</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">## setting stronger priors.</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: There were 70 divergent transitions after warmup. Increasing</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="do">## adapt_delta above 0.8 may help. See</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="do">## http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  Family: gaussian </span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   Links: mu = identity; sigma = identity </span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Formula: RTlexdec ~ 1 + WrittenFrequency_c + Familiarity_c + SubjectYoung </span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="do">##    Data: english_25 (Number of observations: 25) </span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="do">##   Draws: 4 chains, each with iter = 100; warmup = 25; thin = 1;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="do">##          total post-warmup draws = 300</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Regression Coefficients:</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="do">##                    Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="do">## Intercept              6.53      0.02     6.50     6.58 1.10       96       53</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="do">## WrittenFrequency_c    -0.02      0.02    -0.06     0.03 1.12       29       45</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="do">## Familiarity_c         -0.05      0.03    -0.12     0.01 1.12       27       63</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="do">## SubjectYoung          -0.20      0.03    -0.28    -0.14 1.08      114      132</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="do">## Further Distributional Parameters:</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="do">##       Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="do">## sigma     0.10      0.02     0.07     0.14 1.66        7       74</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="do">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="do">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="do">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There is a lot of output here suggesting this is not a good fit, discussed more below (<a href="#sec-ex-bad-model-2" class="quarto-xref"><span>Section 4.3.2.2</span></a>). For the moment, consider marginal and pairwise posterior plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(english_iter100_m51, <span class="at">type =</span> <span class="st">"hist"</span>, <span class="at">bins =</span> <span class="dv">20</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="do">## plot just parameters starting with 'b' or 'sig'(regression coeffs, sigma):</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_pairs</span>(english_iter100_m51,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">regex_pars =</span> <span class="st">"^(b|sig)"</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">off_diag_args =</span> <span class="fu">list</span>(<span class="at">size =</span> <span class="fl">0.75</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>These plots do not look like enough samples have been taken to approximate the distribution, for most parameters.</p>
<p>See the bayesplot <a href="https://cran.r-project.org/web/packages/bayesplot/vignettes/plotting-mcmc-draws.html">vignette</a> for various functions for plotting MCMC draws (from the posterior).</p>
<div id="exr-brm2-4" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4.2</strong></span> In <a href="week4.html#sec-brm1-beta1-prior" class="quarto-xref"><span>Section 3.2.1.2</span></a>, we made a “hex plot” showing the bivariate posterior distribution of two coefficients for model <code>english_m41</code>. This exercise is to make a similar hex plot for the high-colinearity example model from <a href="week4.html#sec-brm1-collinearity" class="quarto-xref"><span>Section 3.3.3</span></a> (<code>english_collin_m1</code>).</p>
<ol type="a">
<li><p>Figure out what <strong>bayesplot function</strong> is used to make this kind of plot.</p></li>
<li><p>What are the names of the regression coefficients in model <code>english_collin_m1</code> corresponding to the predictors for word frequency (<code>WrittenFrequency_c</code>) and familiarity (<code>Familiarity_c</code>)?</p></li>
<li><p>Apply the function from (a) to <code>english_coliln_m1</code> (which you’ll have to load or re-fit) to show a hex plot for the predictors from (b).</p></li>
</ol>
</div>
</section>
</section>
<section id="mcmc-diagnostics" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2" class="anchored" data-anchor-id="mcmc-diagnostics"><span class="header-section-number">4.3.2</span> MCMC Diagnostics</h3>
<p>We will show plots of some MCMC diagnostics mentioned in brms output:</p>
<ul>
<li>Rhat: measures <em>mixing</em> of chains—related to ratio of within-chain versus between-chain variance of samples.
<ul>
<li>We want Rhat near 1 for all parameters. Rhat above 1.1 or 1.05 is cause for concern (though these are arbitrary cutoffs).</li>
</ul></li>
<li>ESS: effective sample size, measures how <em>independent</em> samples within the same chain are (degree of autocorrelation).
<ul>
<li>ESS <span class="math inline">\(&lt;\)</span> “total post-warmup draws” = some autocorrelation. Not a problem, necessarily, but we’ll need more samples to summarize the posterior. ESS far below “total post-warmup draws” suggests a problem.</li>
<li>ESS <span class="math inline">\(&gt;\)</span> “total post-warmup draws” = anticorrelated samples. This is great, but not necessary.</li>
</ul></li>
</ul>
<p>The <a href="https://mc-stan.org/bayesplot/articles/visual-mcmc-diagnostics.html">bayesplot vignette</a> on MCMC diagnostics is very useful and informative. We will show just a few kinds of plots demonstrated there, using the <code>mcmc_plot()</code> function from brms that interfaces with bayesplot.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a></p>
<section id="example-good-model-1" class="level4" data-number="4.3.2.1">
<h4 data-number="4.3.2.1" class="anchored" data-anchor-id="example-good-model-1"><span class="header-section-number">4.3.2.1</span> Example: good model</h4>
<p>First, some plots for a well-behaved model: <code>english_m53</code>, our cubic effect of <code>WrittenFrequency</code> model, fitted with default brms settings:</p>
<ul>
<li>4 chains</li>
<li>Each chain has 1000 warmup and 1000 post-warmup draws</li>
<li>Total post-warmup draws: 4000</li>
</ul>
<p>Trace plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(english_m53, <span class="at">type =</span> <span class="st">"trace"</span>) <span class="sc">+</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## the following two lines just make the output legible, and</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## are optional</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">10</span>)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>parameter, <span class="at">nrow =</span> <span class="dv">3</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free"</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="do">## No divergences to plot.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p><em>Autocorrelation plots</em>, for samples from the posterior for model parameters:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(english_m53, <span class="at">type =</span> <span class="st">"acf"</span>) <span class="sc">+</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## following line just makes the output more legible</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## / is optional</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p><em><span class="math inline">\(\hat{R}\)</span> plot</em>, showing Rhat values for each model parameter:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(english_m53, <span class="at">type =</span> <span class="st">'rhat'</span>) <span class="sc">+</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## adds parameter names on y-axis</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">yaxis_text</span>(<span class="at">hjust =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>These values of <span class="math inline">\(R_{hat}\)</span> are fine—none is anywhere near the 1.05 cutoff.</p>
<p>Since realistic (e.g.&nbsp;mixed-effects) models have dozens-hundreds of parameters, the default display for an rhat plot doesn’t show any labels (just take out the <code>yaxis_text(hjust = 1)</code> line above to see this.)</p>
<p><em>ESS plot</em> (i.e., <span class="math inline">\(n_{eff}\)</span>) for each coefficient:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">neff_ratio</span>(english_m53) <span class="sc">%&gt;%</span> <span class="fu">mcmc_neff</span>(<span class="at">size =</span> <span class="dv">2</span>) <span class="sc">+</span> <span class="fu">yaxis_text</span>(<span class="at">hjust =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Sampling is very efficient (<span class="math inline">\(N_{eff}/N &gt; 0.5\)</span>).</p>
<div id="exr-brm2-5" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4.3 (Extra)</strong></span> The <span class="math inline">\(\hat{R}\)</span> and ESS plots above would be cleaner if they (a) just showed fitted model parameters (regression coefficients and <span class="math inline">\(\sigma\)</span>), and (b) put the parameters in a sensible order: Intercept, then other <code>b_</code> parameters, then <code>sigma</code>.</p>
<p>Figure out how to make versions of these plots implementing (a) and (b).</p>
<p>This is good practice in either reading documentation or interacting with a chatbot (ChatGPT or GitHub Copilot).</p>
</div>
</section>
<section id="sec-ex-bad-model-2" class="level4" data-number="4.3.2.2">
<h4 data-number="4.3.2.2" class="anchored" data-anchor-id="sec-ex-bad-model-2"><span class="header-section-number">4.3.2.2</span> Example: bad model</h4>
<p>Trace plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_plot</span>(english_iter100_m51, <span class="at">type =</span> <span class="st">"trace"</span>) <span class="sc">+</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## the following lines is optional / makes the output legible</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">strip.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>These do not look like hairy caterpillars:</p>
<ul>
<li>The chains have not mixed—they are not on top of each other (for some parameters, like sigma, SubjectYoung)</li>
<li>They are not stationary: there is a definite trend in e.g.&nbsp;the sigma chains, as opposed to flat horizontal lines, with lots of vertical “hair” indicating effective sampling.</li>
<li>They include many divergences (as also indicated in the model output above).</li>
</ul>
<div id="exr-brm2-2" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4.4</strong></span> &nbsp;</p>
<ol type="a">
<li><p>Make the other diagnostic plots as above, now for model <code>english_iter100_m51</code>. What problems do you see?</p></li>
<li><p>Which parameter(s) are particularly poorly estimated by the model, or otherwise problematic?</p></li>
</ol>
</div>
<!-- ```{r} -->
<!-- english_iter200_m51 <- -->
<!--   brm(data = english_25, -->
<!--       RTlexdec ~ 1 + WrittenFrequency_c + Familiarity_c + SubjectYoung, -->
<!--       family = gaussian, -->
<!--       prior = c(prior(normal(0, 100), class=Intercept), -->
<!--                 prior(normal(0,5), class=b), -->
<!--                 prior(exponential(1), class = sigma) -->
<!--       ), iter=200, -->
<!--       file='english_iter200_m51' -->
<!--   ) -->
<!-- ``` -->
<!-- - Reff for sigma > 1.25 -->
<!-- - neff/N also low -->
<!-- ```{r} -->
<!-- posterior_samples(french_cdi_m52, add_chain = TRUE) %>%  mutate(Chain=chain)  %>% -->
<!-- dplyr::select(matches("(b_|sig|chai)")) %>%  mcmc_pairs(diag_fun='dens') -->
<!-- ``` -->
<div id="exr-brm2-6" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4.5 (Extra)</strong></span> &nbsp;</p>
<ol type="a">
<li><p>Refit the model with <code>iter=200</code>, <code>warmup=100</code>. What parameter(s) are still problematic?<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p></li>
<li><p>Try to install the <code>shinystan</code> package, and run <code>shinystan::launch_shinystan()</code> on one of your models to explore MCMC diagnostics.</p></li>
</ol>
</div>
</section>
</section>
</section>
<section id="sec-brm2-contrasts" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="sec-brm2-contrasts"><span class="header-section-number">4.4</span> Working with multi-level factors and contrasts</h2>
<p>This is conceptually similar to frequentist models, covered in Chap. 7 of <span class="citation" data-cites="rmld-book">Sonderegger (<a href="references.html#ref-rmld-book" role="doc-biblioref">2023</a>)</span>. Any multi-level factor requires choosing a contrast coding scheme, and it is possible to interpret the fitted model either by interpreting the coefficient corresponding to a contrast (e.g.&nbsp;“level 2 minus level 1”: <em>RMLD</em> Sec. 7.2), or using post-hoc tests (<em>RMLD</em> Sec. 7.3).</p>
<p>In a Bayesian regression model, a “post-hoc test” can be thought of as summarizing the posterior:</p>
<ul>
<li>To ask the model, “What is the predicted difference in <span class="math inline">\(y\)</span> between level 2 and level 1 of factor <span class="math inline">\(x\)</span>?” :
<ul>
<li>Calculate many times using the posterior: predictions for <span class="math inline">\(y\)</span> when <span class="math inline">\(x\)</span> = level 1 and <span class="math inline">\(x\)</span> = level2, with other predictors held constant. (That is, choose a draw of the model coefficients, then use these to calculate the two predictions.)</li>
<li>Calculate the difference in these predictions, <span class="math inline">\(\delta\)</span>, for each posterior draw.</li>
<li>Summarize the posterior distribution of <span class="math inline">\(\delta\)</span> as desired (e.g.&nbsp;mean + 95% CI).</li>
</ul></li>
</ul>
<p>Let’s use as an example the <code>french_cdi_24</code> data. We recode <code>lexical_class</code> using Helmert contrasts (<em>RMLD</em> Sec. 7.2.8):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrasts</span>(french_cdi_24<span class="sc">$</span>lexical_class) <span class="ot">&lt;-</span> <span class="fu">contr.helmert</span>(<span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, fit a Bayesian model like <code>cdi_cc_mod_1</code>, the frequentist (logistic regression) model described there. We’ll use similar “uninformative” priors to the <code>diatones</code> model (<a href="week4.html#sec-brm1-logistic" class="quarto-xref"><span>Section 3.4.1</span></a>), which also used logistic regression.<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>french_cdi_m51 <span class="ot">&lt;-</span> <span class="fu">brm</span>(</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> french_cdi_24,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  produces <span class="sc">|</span> <span class="fu">trials</span>(<span class="dv">1</span>) <span class="sc">~</span> lexical_class,</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">family =</span> binomial,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">prior =</span> <span class="fu">c</span>(</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">5</span>), <span class="at">class =</span> Intercept),</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">prior</span>(<span class="fu">normal</span>(<span class="dv">0</span>, <span class="dv">3</span>), <span class="at">class =</span> b)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  ), <span class="at">file =</span> <span class="st">"models/french_cdi_m51"</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>french_cdi_m51</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  Family: binomial </span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">##   Links: mu = logit </span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Formula: produces | trials(1) ~ lexical_class </span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="do">##    Data: french_cdi_24 (Number of observations: 560) </span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="do">##   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="do">##          total post-warmup draws = 4000</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Regression Coefficients:</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="do">##                Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Intercept         -0.28      0.11    -0.50    -0.07 1.00     3893     3269</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="do">## lexical_class1     0.47      0.16     0.16     0.78 1.00     3765     3088</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="do">## lexical_class2     0.21      0.10     0.02     0.41 1.00     3699     2926</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="do">## lexical_class3     0.21      0.04     0.13     0.30 1.00     4049     3196</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="do">## and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="do">## scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We could do the whole process described above by getting model predictions for each level of <code>lexical_class</code>, for many posterior distributions (e.g.&nbsp;using <code>spread_draws()</code> from tidybayes). Instead we can use the emmeans package, which works with <code>brms</code> models analogously to its use with frequentist models. See <a href="week4.html#sec-brm1-marginal" class="quarto-xref"><span>Section 3.3.1</span></a> (and the “Practical note” box there) for more on emmeans / similar packages for computing “marginal effects”.</p>
<p>To test for pairwise differences (“Tukey HSD”) between levels, for example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>emm1 <span class="ot">&lt;-</span> <span class="fu">emmeans</span>(french_cdi_m51, <span class="sc">~</span>lexical_class)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(emm1, <span class="st">"tukey"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  contrast                    estimate lower.HPD upper.HPD</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  function_words - verbs        -0.939    -1.537    -0.311</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  function_words - adjectives   -1.112    -1.796    -0.419</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  function_words - nouns        -1.545    -2.071    -0.984</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  verbs - adjectives            -0.166    -0.807     0.440</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  verbs - nouns                 -0.604    -1.059    -0.168</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  adjectives - nouns            -0.430    -0.967     0.112</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Point estimate displayed: median </span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="do">## Results are given on the log odds ratio (not the response) scale. </span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="do">## HPD interval probability: 0.95</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We might say the 95% HPDs which don’t overlap zero correspond to levels which “are different”, so:</p>
<ul>
<li>function_words <span class="math inline">\(&lt;\)</span> verbs, adjectives, nouns</li>
<li>verbs <span class="math inline">\(&lt;\)</span> nouns</li>
</ul>
<p>Visualize the actual posterior of these differences (code from <a href="https://gist.github.com/jebyrnes/d1bdea4ad4c8736c4b9e7ac290e8c940">here</a>), using the <code>gather_emmeans_draws()</code> function from tidybayes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>cont <span class="ot">&lt;-</span> <span class="fu">contrast</span>(emm1, <span class="st">"tukey"</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>cont_posterior <span class="ot">&lt;-</span> <span class="fu">gather_emmeans_draws</span>(cont)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  cont_posterior,</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">y =</span> contrast, <span class="at">x =</span> .value, <span class="at">fill =</span> contrast, <span class="at">group =</span> contrast)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_halfeyeh</span>(<span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning in geom_halfeyeh(alpha = 0.5): 'geom_halfeyeh' is deprecated.</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Use 'stat_halfeye' instead.</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="do">## See help("Deprecated") and help("tidybayes-deprecated").</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Another plot, by level:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>french_cdi_m51 <span class="sc">%&gt;%</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">emmeans</span>(<span class="sc">~</span>lexical_class) <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gather_emmeans_draws</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> lexical_class, <span class="at">y =</span> .value)) <span class="sc">+</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_eye</span>() <span class="sc">+</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="fu">aes</span>(<span class="at">group =</span> <span class="cn">NA</span>), <span class="at">fun.y =</span> mean, <span class="at">geom =</span> <span class="st">"line"</span>) <span class="sc">+</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_light</span>()</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning in geom_eye(): 'geom_eye' is deprecated.</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="do">## Use 'stat_eye' instead.</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="do">## See help("Deprecated") and help("tidybayes-deprecated").</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Warning: The `fun.y` argument of `stat_summary()` is deprecated as of ggplot2 3.3.0.</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="do">## ℹ Please use the `fun` argument instead.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="week5_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>Compare to frequentist model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>cdi_cc_mod_1 <span class="ot">&lt;-</span> <span class="fu">glm</span>(produces <span class="sc">~</span> lexical_class, <span class="at">data =</span> french_cdi_24, <span class="at">family =</span> <span class="st">"binomial"</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(cdi_cc_mod_1, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="do">## # A tibble: 4 × 7</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="do">##   term           estimate std.error statistic    p.value conf.low conf.high</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="do">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 (Intercept)      -0.277    0.107      -2.59 0.00965     -0.489    -0.0690</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 lexical_class1    0.462    0.160       2.88 0.00398      0.153     0.784 </span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 lexical_class2    0.212    0.101       2.09 0.0368       0.0126    0.411 </span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 lexical_class3    0.213    0.0449      4.74 0.00000213   0.125     0.302</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">contrast</span>(<span class="fu">emmeans</span>(cdi_cc_mod_1, <span class="sc">~</span>lexical_class), <span class="st">"tukey"</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  contrast                    estimate    SE  df z.ratio p.value</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  function_words - verbs        -0.923 0.321 Inf  -2.880  0.0208</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  function_words - adjectives   -1.096 0.364 Inf  -3.014  0.0138</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="do">##  function_words - nouns        -1.525 0.281 Inf  -5.424  &lt;.0001</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="do">##  verbs - adjectives            -0.173 0.322 Inf  -0.536  0.9502</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="do">##  verbs - nouns                 -0.602 0.225 Inf  -2.673  0.0377</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  adjectives - nouns            -0.429 0.283 Inf  -1.515  0.4287</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Results are given on the log odds ratio (not the response) scale. </span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="do">## P value adjustment: tukey method for comparing a family of 4 estimates</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that the Bayesian method does <strong>not</strong> explicitly correct for multiple comparisons, in part because there are no hypothesis tests per se in a (fully) Bayesian framework. How/whether to correct for “multiplicity” in Bayesian models is a big <a href="https://stats.stackexchange.com/questions/203378/why-dont-bayesian-methods-require-multiple-testing-corrections">debate</a>, but the short answer is that:</p>
<ul>
<li>Making multiple comparisons using the posterior will often give a similar result to a frequentist procedure where multiple comparisons are explicitly corrected for.</li>
<li>In common cases, emmeans will do something sensible for you.</li>
</ul>
<div id="exr-brm2-3" class="theorem exercise">
<p><span class="theorem-title"><strong>Exercise 4.6 (Extra)</strong></span> It may be of interest to calculate other summaries of this child’s lexical knowledge than can be easily calculated by emmeans. Suppose we were interested in the noun/verb ratio: the odds of knowing a word if it’s a noun (<span class="math inline">\(p_{noun}\)</span>/(<span class="math inline">\(1-p_{noun}\)</span>)), divided by the odds of knowing a word if it’s a verb.</p>
<ol type="a">
<li><p>Sample from the posterior, at each draw getting predicted values for each level of <code>lexical_class</code>, in <em>probability</em></p></li>
<li><p>For each draw, calculate <span class="math inline">\(p_{noun}\)</span> and <span class="math inline">\(p_{verb}\)</span>, and add these to the dataframe.</p></li>
<li><p>For each draw, calculate the “noun/verb ratio” defined above.</p></li>
<li><p>Plot the posterior distribution of the N/V ratio.</p></li>
</ol>
</div>
</section>
<section id="sec-brm2-extra" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="sec-brm2-extra"><span class="header-section-number">4.5</span> Extra</h2>
<section id="frequentist-models-for-nonlinear-effect-of-writtenfrequency" class="level3" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="frequentist-models-for-nonlinear-effect-of-writtenfrequency"><span class="header-section-number">4.5.1</span> Frequentist models for nonlinear effect of <code>WrittenFrequency</code></h3>
<p>Fit frequentist linear models corresponding to Bayesian models in <a href="#sec-example-nonlinear" class="quarto-xref"><span>Section 4.2.1</span></a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>english_m51_freq <span class="ot">&lt;-</span> <span class="fu">lm</span>(RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> WrittenFrequency_c <span class="sc">+</span> SubjectYoung, <span class="at">data =</span> english_250)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>english_m52_freq <span class="ot">&lt;-</span> <span class="fu">lm</span>(RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">poly</span>(WrittenFrequency_c, <span class="dv">2</span>) <span class="sc">+</span> SubjectYoung, <span class="at">data =</span> english_250)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>english_m53_freq <span class="ot">&lt;-</span> <span class="fu">lm</span>(RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">poly</span>(WrittenFrequency_c, <span class="dv">3</span>) <span class="sc">+</span> SubjectYoung, <span class="at">data =</span> english_250)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>english_m54_freq <span class="ot">&lt;-</span> <span class="fu">lm</span>(RTlexdec <span class="sc">~</span> <span class="dv">1</span> <span class="sc">+</span> <span class="fu">poly</span>(WrittenFrequency_c, <span class="dv">4</span>) <span class="sc">+</span> SubjectYoung, <span class="at">data =</span> english_250)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Choose the best model using <span class="math inline">\(F\)</span>-tests, AIC, or BIC for model comparison:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(english_m51_freq, english_m52_freq, english_m53_freq, english_m54_freq)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Analysis of Variance Table</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Model 1: RTlexdec ~ 1 + WrittenFrequency_c + SubjectYoung</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="do">## Model 2: RTlexdec ~ 1 + poly(WrittenFrequency_c, 2) + SubjectYoung</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="do">## Model 3: RTlexdec ~ 1 + poly(WrittenFrequency_c, 3) + SubjectYoung</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="do">## Model 4: RTlexdec ~ 1 + poly(WrittenFrequency_c, 4) + SubjectYoung</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="do">##   Res.Df    RSS Df Sum of Sq      F  Pr(&gt;F)  </span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="do">## 1    247 1.7321                              </span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 2    246 1.7105  1 0.0216134 3.1191 0.07863 .</span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="do">## 3    245 1.6908  1 0.0196451 2.8350 0.09351 .</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="do">## 4    244 1.6908  1 0.0000362 0.0052 0.94247  </span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="do">## ---</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="do">## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(english_m51_freq, english_m52_freq, english_m53_freq, english_m54_freq)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a><span class="do">##                  df       AIC</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51_freq  4 -525.5652</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52_freq  5 -526.7044</span></span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53_freq  6 -527.5923</span></span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54_freq  7 -525.5977</span></span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a><span class="fu">BIC</span>(english_m51_freq, english_m52_freq, english_m53_freq, english_m54_freq)</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a><span class="do">##                  df       BIC</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m51_freq  4 -511.4794</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m52_freq  5 -509.0971</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m53_freq  6 -506.4636</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="do">## english_m54_freq  7 -500.9474</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>BIC or <span class="math inline">\(F\)</span>-tests: linear model best</li>
<li>AIC: cubic model best</li>
</ul>
<!-- Diatones model: -->
<!-- ```{r} -->
<!-- diatones_m51 <-brm(data = diatones, -->
<!--                    stress_shifted | trials(1) ~ syll2_coda + syll2_td + frequency + syll1_coda, -->
<!--                    family = binomial, -->
<!--                    prior = c(prior(normal(0,5), class=Intercept), -->
<!--                              prior(normal(0,5), class=b)), -->
<!--                    iter=50) -->
<!-- ``` -->
<!-- # Other reading -->
<!-- Overall Bayesian workflow: -->
<!-- * @gabry2019visualization: ["Visualization in Bayesian workflow"](https://arxiv.org/abs/1709.01449) -->
<!--   * Useful notes from [Monica Alexander](https://www.monicaalexander.com/posts/2020-28-02-bayes_viz/). -->
<!-- * @gelman2020bayesian: ["Bayesian workflow"](https://arxiv.org/abs/2011.01808) -->
<!-- * @schad2021toward: ["Toward a principled Bayesian workflow in cognitive science"](https://arxiv.org/abs/1904.12765) -->


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-flego2021leveraging" class="csl-entry" role="listitem">
Flego, Stefon, and Jon Forrest. 2021. <span>“Leveraging the Temporal Dynamics of Anticipatory Vowel-to-Vowel Coarticulation in Linguistic Prediction: A Statistical Modeling Approach.”</span> <em>Journal of Phonetics</em> 88: 101093.
</div>
<div id="ref-gabry2019visualization" class="csl-entry" role="listitem">
Gabry, Jonah, Daniel Simpson, Aki Vehtari, Michael Betancourt, and Andrew Gelman. 2019. <span>“Visualization in Bayesian Workflow.”</span> <em>Journal of the Royal Statistical Society: Series A (Statistics in Society)</em> 182 (2): 389–402.
</div>
<div id="ref-kurz2021statistical" class="csl-entry" role="listitem">
Kurz, S. 2023. <em>Statistical Rethinking (Second Edition) with Brms, Ggplot2, and the Tidyverse</em>. <a href="https://bookdown.org/content/4857/" class="uri">https://bookdown.org/content/4857/</a>.
</div>
<div id="ref-mcelreath2020statistical" class="csl-entry" role="listitem">
McElreath, Richard. 2020. <em>Statistical Rethinking: A <span>B</span>ayesian Course with Examples in <span>R</span> and <span>S</span>tan</em>. Second. Chapman; Hall/CRC.
</div>
<div id="ref-rmld-book" class="csl-entry" role="listitem">
Sonderegger, Morgan. 2023. <em>Regression Modeling for Linguistic Data</em>. MIT Press, <a href="https://osf.io/pnumg/" class="uri">https://osf.io/pnumg/</a>, preprint at <a href="https://github.com/msonderegger/rmld-v1.1/" class="uri">https://github.com/msonderegger/rmld-v1.1/</a>.
</div>
<div id="ref-loo-package" class="csl-entry" role="listitem">
Vehtari, Aki, Jonah Gabry, Måns Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, and Andrew Gelman. 2024. <span>“Loo: Efficient Leave-One-Out Cross-Validation and WAIC for Bayesian Models.”</span> <a href="https://mc-stan.org/loo/">https://mc-stan.org/loo/</a>.
</div>
<div id="ref-vehtari2017practical" class="csl-entry" role="listitem">
Vehtari, Aki, Andrew Gelman, and Jonah Gabry. 2017. <span>“Practical Bayesian Model Evaluation Using Leave-One-Out Cross-Validation and WAIC.”</span> <em>Statistics and Computing</em> 27: 1413–32. <a href="https://doi.org/10.1007/s11222-016-9696-4">https://doi.org/10.1007/s11222-016-9696-4</a>.
</div>
</div>
</section>
</section>
<section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr>
<ol>
<li id="fn1"><p> <code>elpd_waic</code> is just WAIC/(-2)—it’s in units of log-probability rather than “deviance”. This doesn’t matter for model comparison. <code>p_waic</code> is the effective number of model parameters. It’s not usually used, but can be more intuitive than ELPD/WAIC. Note that the model has 5.2 “effective” parameters, despite having 6 actual parameters, suggesting that some of them are not doing much. <code>elpd_loo</code>/<code>p_loo</code> are analogous to the same for WAIC.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p>For example, <code>mcmc_plot(my_brms_model, type = 'trace')</code> shows the same thing as <code>mcmc_plot(my_rstan_model)</code>. <a href="https://bookdown.org/content/4857/markov-chain-monte-carlo.html#care-and-feeding-of-your-markov-chain">This section</a> of <span class="citation" data-cites="kurz2021statistical">Kurz (<a href="references.html#ref-kurz2021statistical" role="doc-biblioref">2023</a>)</span> shows how to use the actual bayesplot functions with brms models.<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3"><p>(Don’t read until you’ve answered.). This illustrates a very general fact about regression models: estimating means (the “population-level effects”) takes less data / sampling from the posterior than estimating variances (here, “Family-specific parameters”).<a href="#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4"><p>In a real model of this data we’d want to figure out weakly informative priors, but it will make no difference given the size of this dataset.<a href="#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./week4.html" class="pagination-link" aria-label="Bayesian Regression Models 1">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Bayesian Regression Models 1</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./week9.html" class="pagination-link" aria-label="Bayesian Hierarchical Models 1">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Bayesian Hierarchical Models 1</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




</body></html>